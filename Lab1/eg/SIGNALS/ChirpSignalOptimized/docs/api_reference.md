# API 参考文档

本文档详细描述了二次调频信号分析工具包中的函数接口、参数和使用方法，严格区分相关数学概念。

## 1. 信号生成函数

### `crcbgenqcsig`

#### 功能描述

生成具有指定相位参数的二次调频信号，相位函数为时间的三次多项式。

#### 语法

```matlab
sigVec = crcbgenqcsig(timeVec, A, phaseCoeff)
```

#### 输入参数

| 参数 | 描述 | 类型 | 要求 |
|------|------|------|------|
| `timeVec` | 时间采样点向量(秒) | 数值向量 | 实数向量 |
| `A` | 信号幅度 | 标量 | 实数 |
| `phaseCoeff` | 相位参数 [a1, a2, a3] (弧度/秒, 弧度/秒^2, 弧度/秒^3) | 3元素向量 | 实数向量 |

#### 输出参数

| 参数 | 描述 | 类型 |
|------|------|------|
| `sigVec` | 生成的信号样本 | 与timeVec同维度的向量 |

#### 数学表示

函数计算相位函数：
$$\phi(t) = a_1t + a_2t^2 + a_3t^3$$

然后生成余弦信号：
$$s(t) = A\cos(\phi(t))$$

对应的瞬时频率为：
$$f_i(t) = \frac{1}{2\pi}\frac{d\phi(t)}{dt} = \frac{1}{2\pi}(a_1 + 2a_2t + 3a_3t^2)$$

#### 示例

```matlab
% 生成1秒长的二次调频信号，采样频率为1000Hz
t = 0:0.001:1;
A = 10;
phaseCoeff = [10, 3, 3]; % [a1, a2, a3]，单位为弧度/秒, 弧度/秒^2, 弧度/秒^3
signal = crcbgenqcsig(t, A, phaseCoeff);
plot(t, signal);
```

#### 注意事项

- 相位参数单位为弧度/秒^n（其中n为参数的阶数）
- 输入参数未经过规范化，请确保时间向量单位为秒
- 信号频率特性完全由相位参数决定
- A通常表示幅度而非信噪比(SNR)，代码注释可能有误

## 2. 信号分析脚本

### `testcrcbgenqcsig`

#### 功能描述

一个完整的脚本，用于生成二次调频信号并进行时域、频域和时频分析，展示了两种Nyquist频率定义的应用。

#### 主要部分

1. **参数设置**
   - 相位参数（a1, a2, a3）- 单位：弧度/秒^n
   - 信号幅度（A）
   - 采样参数计算，包括Nyquist频率（两种定义）

2. **信号生成**
   - 调用`crcbgenqcsig`生成二次调频信号

3. **时域分析**
   - 绘制采样信号的时域波形

4. **频域分析**
   - 完整频谱（包含正负频率）- 使用`fftshift`
   - 周期图（仅正频率部分）- 利用实信号FFT的共轭对称性

5. **时频分析**
   - 使用短时傅里叶变换生成频谱图

#### 关键参数与计算

| 参数/计算 | 公式/默认值 | 描述 |
|------|--------|------|
| `a1`, `a2`, `a3` | 10, 3, 3 | 相位函数参数（弧度/秒^n） |
| `A` | 10 | 信号幅度 |
| `maxFreq` | a1 + 2*a2 + 3*a3 | 最大瞬时频率（t=1时） |
| `nyqFreq` | 2*maxFreq | Nyquist频率（第一种定义：临界采样频率） |
| `samplFreq` | 5*nyqFreq | 实际采样频率（临界采样频率的5倍） |
| `kNyq` | floor(nSamples/2)+1 | 对应Nyquist频率（第二种定义：fs/2）的FFT索引 |
| `winLen` | 0.2 秒 | 频谱图窗口长度 |
| `ovrlp` | 0.1 秒 | 频谱图窗口重叠长度 |

#### FFT结果处理

脚本中处理FFT结果的关键步骤：

1. 计算所有频率点（包括正负频率）：
   ```matlab
   allFreq = ((-samplFreq/2):(-samplFreq/2+(nSamples-1)*(1/dataLen)));
   ```

2. 计算FFT并将零频分量移至中心：
   ```matlab
   fftSig = fft(sigVec);
   fftSig_shifted = fftshift(fftSig);
   ```
   此时`fftSig`的频率排列为：`[0Hz, 正频率..., Nyquist频率, 负频率...]`
   使用`fftshift`后变为：`[负频率..., 0Hz, 正频率..., Nyquist频率]`

3. 利用实信号FFT的共轭对称性，仅保留正频率部分：
   ```matlab
   kNyq = floor(nSamples/2) + 1;  % 对应fs/2的索引
   fftSig = fftSig(1:kNyq);       % 只保留[0,fs/2]频率范围
   ```

#### 时频分析实现

```matlab
[S, F, T] = spectrogram(sigVec, winLenSmpls, ovrlpSmpls, [], samplFreq);
```

参数说明：
- `winLenSmpls`：窗口长度（采样点数）= winLen * samplFreq
- `ovrlpSmpls`：重叠长度（采样点数）= ovrlp * samplFreq
- `samplFreq`：采样频率（Hz）
- 返回值：
  - `S`：短时傅里叶变换矩阵
  - `F`：频率向量（Hz）
  - `T`：时间向量（秒）

#### 使用方法

脚本无需参数，直接运行即可：

```matlab
testcrcbgenqcsig
```

## 3. 频率相关概念澄清

### Nyquist频率的两种定义

1. **临界采样频率（Nyquist Rate）**
   - 定义：$f_s = 2f_B$，其中$f_B$是信号带宽
   - 应用：确定给定带宽信号的最小采样频率
   - 在代码中：`nyqFreq = 2*maxFreq;`

2. **采样率的一半（Nyquist Limit）**
   - 定义：$f_{Nyq} = \frac{f_s}{2}$
   - 应用：确定给定采样率下可无混叠表示的最高频率
   - 在代码中：`kNyq = floor(nSamples/2)+1;`（对应FFT索引）

### 带宽（Bandwidth）

- 定义：信号在频域中占据的频率范围
- 对于调频信号：近似等于最大瞬时频率与最小瞬时频率之差
- 在代码中：`maxFreq`近似表示信号带宽的上限

### 采样频率（Sampling Frequency）

- 定义：单位时间内对信号进行采样的次数
- 单位：Hz（赫兹）
- 在代码中：`samplFreq = 5*nyqFreq;`

### 瞬时频率（Instantaneous Frequency）

- 定义：信号相位函数对时间的导数除以$2\pi$
- 数学表达：$f_i(t) = \frac{1}{2\pi}\frac{d\phi(t)}{dt}$
- 对于二次调频信号：$f_i(t) = \frac{1}{2\pi}(a_1 + 2a_2t + 3a_3t^2)$
- 在代码中：`maxFreq = a1+2*a2+3*a3;`（t=1时的瞬时频率，省略了$2\pi$）

## 4. MATLAB内置函数

### `spectrogram`

#### 语法

```matlab
[S, F, T] = spectrogram(x, window, noverlap, nfft, fs)
```

#### 主要参数

| 参数 | 描述 |
|------|------|
| `x` | 输入信号 |
| `window` | 窗口函数或长度 |
| `noverlap` | 重叠样本数 |
| `nfft` | FFT长度（可选） |
| `fs` | 采样频率 |

#### 返回值

| 参数 | 描述 |
|------|------|
| `S` | 短时傅里叶变换矩阵 |
| `F` | 频率向量（Hz） |
| `T` | 时间向量（秒） |

### `fft` 和 `fftshift`

- `fft`：计算离散傅里叶变换
  - 结果排列：[0Hz, 正频率..., fs/2, 负频率...]
  - 对于实信号，满足共轭对称性：X[N-k] = X*[k]

- `fftshift`：将FFT结果的零频率分量移至中心
  - 变换后排列：[负频率..., 0Hz, 正频率...]
  - 便于频谱可视化和对称性分析

## 5. 常见问题

1. **为什么代码中计算瞬时频率时没有除以2π？**
   
   在代码中计算`maxFreq = a1+2*a2+3*a3`时，实际计算的是角频率（弧度/秒）而非循环频率（Hz）。严格来说，应为`maxFreq = (a1+2*a2+3*a3)/(2*pi)`。这是代码中的一个简化，后续处理中隐含地假设单位为Hz。

2. **为什么周期图只显示正频率？**
   
   对于实信号，FFT结果具有共轭对称性，因此负频率部分包含的信息与正频率相同。通常只需展示正频率部分即可完整表示信号的频谱特性。

3. **如何选择合适的窗口长度？**
   
   窗口长度需要权衡时间分辨率和频率分辨率：
   - 时域分辨率：Δt = winLen
   - 频域分辨率：Δf ≈ 1/winLen
   
   对于二次调频信号，窗口长度应小于频率显著变化所需的时间。
